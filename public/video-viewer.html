<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video — Director</title>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; background: #0f0f11; }
    #playerWrap { width: 100%; height: 100%; position: relative; }
    #ytContainer { width: 100%; height: 100%; display: none; }
    #ytContainer.active { display: block; }
    #frame { width: 100%; height: 100%; border: none; display: block; }
    #frame.active { display: block; }
    #frame.hidden { display: none; }
    #status { display: none; position: fixed; bottom: 0; left: 0; right: 0; font-family: system-ui, sans-serif; font-size: 0.75rem; color: #52525b; padding: 0.25rem 0.5rem; background: #18181b; }
  </style>
</head>
<body>
  <div id="playerWrap">
    <div id="ytContainer"><div id="ytPlayerPlaceholder"></div></div>
    <iframe id="frame" title="Video" class="hidden"></iframe>
  </div>
  <p id="status">Connecting…</p>
  <script src="https://www.youtube.com/iframe_api" async></script>
  <script>
    (function () {
      const ytContainer = document.getElementById('ytContainer');
      const ytPlayerPlaceholder = document.getElementById('ytPlayerPlaceholder');
      const frame = document.getElementById('frame');
      const status = document.getElementById('status');

      let ytPlayer = null;
      let ytReady = false;
      let pendingYtVideoId = null;

      window.onYouTubeIframeAPIReady = function () {
        ytReady = true;
        if (pendingYtVideoId) {
          createYtPlayer(pendingYtVideoId);
          pendingYtVideoId = null;
        }
      };

      function getYouTubeVideoId(url) {
        try {
          const u = new URL(url);
          if (u.hostname === 'youtu.be') return u.pathname.slice(1).split('/')[0] || null;
          if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com') && u.pathname === '/watch') return u.searchParams.get('v') || null;
          if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com') && u.pathname.startsWith('/embed/')) return u.pathname.split('/')[2] || null;
          return null;
        } catch (_) { return null; }
      }

      function isYouTubeUrl(url) {
        return !!getYouTubeVideoId(url);
      }

      function createYtPlayer(videoId) {
        if (ytPlayer) {
          ytPlayer.destroy();
          ytPlayer = null;
        }
        ytPlayer = new YT.Player('ytPlayerPlaceholder', {
          videoId: videoId,
          width: '100%',
          height: '100%',
          playerVars: { autoplay: 1 },
          events: {
            onStateChange: function (e) {
              if (e.data === 0) {
                fetch('/video/ended', { method: 'POST' }).catch(function () {});
              }
            }
          }
        });
      }

      function loadUrl(url) {
        if (!url || !url.startsWith('http')) return;
        var videoId = getYouTubeVideoId(url);
        if (videoId) {
          frame.classList.add('hidden');
          frame.removeAttribute('src');
          ytContainer.classList.add('active');
          if (ytReady) {
            createYtPlayer(videoId);
          } else {
            pendingYtVideoId = videoId;
          }
        } else {
          if (ytPlayer) {
            ytPlayer.destroy();
            ytPlayer = null;
          }
          pendingYtVideoId = null;
          ytContainer.classList.remove('active');
          frame.classList.remove('hidden');
          try {
            var u = new URL(url);
            if ((u.hostname === 'www.youtube.com' || u.hostname === 'youtube.com') && u.pathname === '/watch' && u.searchParams.get('v')) {
              url = 'https://www.youtube.com/embed/' + u.searchParams.get('v') + '?autoplay=1';
            } else if (u.hostname === 'youtu.be') {
              url = 'https://www.youtube.com/embed/' + u.pathname.slice(1) + '?autoplay=1';
            }
          } catch (_) {}
          frame.src = url;
        }
        status.textContent = 'Loaded';
      }

      function stopVideo() {
        if (ytPlayer) {
          ytPlayer.destroy();
          ytPlayer = null;
        }
        pendingYtVideoId = null;
        ytContainer.classList.remove('active');
        frame.classList.add('hidden');
        frame.removeAttribute('src');
        status.textContent = 'Waiting for video…';
      }

      var params = new URLSearchParams(window.location.search);
      var initialUrl = params.get('url');
      if (initialUrl && initialUrl.startsWith('http')) loadUrl(initialUrl);

      var ev = new EventSource('/events');
      ev.onopen = function () { if (!frame.src && !ytPlayer) status.textContent = 'Waiting for video…'; };
      ev.onmessage = function (e) {
        try {
          var data = JSON.parse(e.data);
          if (data.type === 'videoUrl' && data.url && typeof data.url === 'string') loadUrl(data.url);
          else if (data.type === 'videoStop') stopVideo();
        } catch (_) {}
      };
      ev.onerror = function () { if (!frame.src && !ytPlayer) status.textContent = 'Reconnecting…'; };
    })();
  </script>
</body>
</html>
